.TH SPAN 1 "JULY 2016" "Leipzig University Library" "Manuals"
.SH NAME
.PP
span\-import, span\-tag, span\-export, span\-check, span\-oa\-filter,
span\-update\-labels, span\-crossref\-snapshot, span\-local\-data, span\-freeze,
span\-review, span\-webhookd \- intermediate schema and integration tools
.SH SYNOPSIS
.PP
\fB\fCspan\-import\fR [\fB\fC\-i\fR \fIinput\-format\fP] < \fIfile\fP
.PP
\fB\fCspan\-tag\fR [\fB\fC\-c\fR \fIconfig\fP, \fB\fC\-unfreeze\fR \fIfile\fP] < \fIfile\fP
.PP
\fB\fCspan\-export\fR [\fB\fC\-o\fR \fIoutput\-format\fP] < \fIfile\fP
.PP
\fB\fCspan\-check\fR [\fB\fC\-verbose\fR] < \fIfile\fP
.PP
\fB\fCspan\-oa\-filter\fR [\fB\fC\-f\fR \fIfile\fP] [\fB\fC\-fc\fR \fIfile\fP] [\fB\fC\-xsid\fR \fIstring\fP] < \fIfile\fP
.PP
\fB\fCspan\-update\-labels\fR [\fB\fC\-f\fR \fIfile\fP, \fB\fC\-s\fR \fIseparator\fP] < \fIfile\fP
.PP
\fB\fCspan\-crossref\-snapshot\fR [\fB\fC\-x\fR \fIfile\fP] \-o \fIfile\fP \fIfile\fP
.PP
\fB\fCspan\-local\-data\fR < \fIfile\fP
.PP
\fB\fCspan\-freeze\fR \-o \fIfile\fP < \fIfile\fP
.PP
\fB\fCspan\-review\fR [\fB\fC\-server\fR \fIurl\fP] [\fB\fC\-span\-config\fR \fIfile\fP] [\fB\fC\-c\fR \fIfile\fP] [\fB\fC\-a\fR] [\fB\fC\-t\fR] [\fB\fC\-ticket\fR \fInumber\fP]
.PP
\fB\fCspan\-webhookd\fR [\fB\fC\-addr\fR \fIhostport\fP] [\fB\fC\-logfile\fR \fIfile\fP] [\fB\fCrepo\-dir\fR \fIpath\fP] [\fB\fC\-span\-config\fR \fIfile\fP] [\fB\fC\-token\fR \fItoken\fP]
.SH DESCRIPTION
.PP
The \fB\fCspan\fR tools convert to and from an intermediate schema and support
license tagging and quality assurance.
.PP
The intermediate schema is a normalization vehicle, spec:
\[la]https://github.com/ubleipzig/intermediateschema\[ra]
.SH OPTIONS
.TP
\fB\fC\-i\fR \fIformat\fP
Input format. \fB\fCspan\-import\fR only.
.TP
\fB\fC\-o\fR \fIformat\fP
Output format or file. \fB\fCspan\-export\fR, \fB\fCspan\-freeze\fR, \fB\fCspan\-crossref\-snapshot\fR only.
.TP
\fB\fC\-c\fR \fIconfig\-string\fP or \fIconfig\-file\fP
Configuration string or path to configuration file. \fB\fCspan\-tag\fR example in
EXAMPLE for a CONFIGURATION FILE. \fB\fCspan\-review\fR details in INDEX REVIEW.
.TP
\fB\fC\-list\fR
List support formats. \fB\fCspan\-import\fR, \fB\fCspan\-export\fR only.
.TP
\fB\fC\-verbose\fR
More output. \fB\fCspan\-check\fR only.
.TP
\fB\fC\-b\fR \fIN\fP
Batch size. \fB\fCspan\-tag\fR, \fB\fCspan\-check\fR, \fB\fCspan\-export\fR, \fB\fCspan\-crossref\-snapshot\fR only.
.TP
\fB\fC\-w\fR \fIN\fP
Number of workers (defaults to CPU count). \fB\fCspan\-tag\fR, \fB\fCspan\-check\fR, \fB\fCspan\-export\fR only.
.TP
\fB\fC\-cpuprofile\fR \fIpprof\-file\fP
Profiling. \fB\fCspan\-import\fR, \fB\fCspan\-tag\fR, \fB\fCspan\-crossref\-snapshot\fR only.
.TP
\fB\fC\-f\fR \fIfile\fP
File location (ISSN list or ID,ISIL). \fB\fCspan\-oa\-filter\fR, \fB\fCspan\-update\-labels\fR only.
.TP
\fB\fC\-fc\fR \fIfile\fP
File in AMSL FreeContent API format about sources, collections and their OA status, \fB\fCspan\-oa\-filter\fR only.
.TP
\fB\fC\-s\fR \fIsep\fP
Field separator. \fB\fCspan\-update\-labels\fR only.
.TP
\fB\fC\-unfreeze\fR \fIfile\fP
Take a file created with \fB\fCspan\-freeze\fR and use it instead of a filterconfig. \fB\fCspan\-tag\fR only.
.TP
\fB\fC\-v\fR
Show version.
.TP
\fB\fC\-x\fR \fIfile\fP
Filename to DOI to exclude, one per line. \fB\fCspan\-crossref\-snapshot\fR only.
.TP
\fB\fC\-xsid\fR \fIsid\fP
Do not apply processing on a given source id. \fB\fCspan\-oa\-filter\fR only.
.TP
\fB\fC\-z\fR
Input is gzip compressed. \fB\fCspan\-crossref\-snapshot\fR only.
.TP
\fB\fC\-addr\fR \fIhostport\fP
Hostport to listen on. \fB\fCspan\-webhookd\fR only.
.TP
\fB\fC\-logfile\fR \fIfile\fP
Logfile to log to. \fB\fCspan\-webhookd\fR only.
.TP
\fB\fC\-repo\-dir\fR \fIpath\fP
Local repo clone. \fB\fCspan\-webhookd\fR only.
.TP
\fB\fC\-span\-config\fR \fIpath\fP
Path to span config. \fB\fCspan\-review\fR, \fB\fCspan\-webhookd\fR only.
.TP
\fB\fC\-token\fR \fItoken\fP
GitLab API token. \fB\fCspan\-webhookd\fR only.
.TP
\fB\fC\-a\fR
Emit ascii table. \fB\fCspan\-review\fR only.
.TP
\fB\fC\-t\fR
Emit textile table for redmine. \fB\fCspan\-review\fR only.
.TP
\fB\fC\-server\fR \fIurl\fP
Location of SOLR, including scheme, host, port and core. \fB\fCspan\-review\fR only.
.TP
\fB\fC\-ticket\fR \fIid\fP
Post review results into a Redmine ticket. \fB\fCspan\-review\fR only.
.TP
\fB\fC\-h\fR
Show usage.
.SH EXAMPLES
.PP
List supported format for conversion to intermediate schema:
.IP
\fB\fCspan\-import \-list\fR
.PP
Convert DOAJ dump into intermediate schema:
.IP
\fB\fCspan\-import \-i doaj dump.ldj\fR
.PP
Apply licensing information from a string with streaming input.
.IP
\fB\fCcat intermediate.file | span\-tag \-c '{"DE\-15": {"any": {}}}'\fR
.PP
Apply licensing information from a configuration file to an intermediate schema file.
.IP
\fB\fCspan\-tag \-c <(echo '{"DE\-15": {"any": {}}})' intermediate.file\fR
.PP
There are a couple of content filters available: \fB\fCany\fR, \fB\fCdoi\fR, \fB\fCissn\fR,
\fB\fCpackage\fR, \fB\fCholdings\fR, \fB\fCcollection\fR, \fB\fCsource\fR and \fB\fCsubject\fR\&. These content
filters can be combined with: \fB\fCor\fR, \fB\fCand\fR and \fB\fCnot\fR\&. The configuration can be
seen as an expression forest. The top level keys are the labels, that will be
injected as \fB\fCx.labels\fR into the document, if the filter below the key evaluates
to true.
.PP
The holdings filter configuration can include a list of URLs. As of 0.1.221 the
the "urls" value supports the \fB\fCfile://\fR scheme as well.
.PP
More complex example for a configuration file:
.PP
.RS
.nf
{
  "DE\-14": {
    "or": [
      {
        "and": [
          {
            "source": [
              "55"
            ]
          },
          {
            "holdings": {
              "urls": [
                "http://www.jstor.org/kbart/collections/asii",
                "http://www.jstor.org/kbart/collections/as"
              ]
            }
          }
        ]
      },
      {
        "and": [
          {
            "source": [
              "49"
            ]
          },
          {
            "holdings": {
              "urls": [
                "https://example.com/KBART_DE14",
                "https://example.com/KBART_FREEJOURNALS"
              ]
            }
          },
          {
            "collection": [
              "Turkish Family Physicans Association (CrossRef)",
              "Helminthological Society (CrossRef)",
              "International Association of Physical Chemists (IAPC) (CrossRef)",
              "The Society for Antibacterial and Antifungal Agents, Japan (CrossRef)",
              "Fundacao CECIERJ (CrossRef)"
            ]
          }
        ]
      }
    ]
  }
}
.fi
.RE
.IP
\fB\fCspan\-tag \-c config.json intermediate.file\fR
.PP
List available export formats:
.IP
\fB\fCspan\-export \-list\fR
.PP
Export to a SOLR schema:
.IP
\fB\fCspan\-export \-o solr5vu3 intermediate.file\fR
.PP
Export to Metafacture formeta:
.IP
\fB\fCspan\-export \-o formeta intermediate.file\fR
.PP
Set OA flag (via KBART\-ish file):
.IP
\fB\fCecho '{"rft.issn": ["1234\-1234"], "rft.date": "2000\-01\-01"}' | span\-oa\-filter \-f <(echo $'online_identifier\\n1234\-1234')\fR
.PP
Update labels:
.IP
\fB\fCecho '{"finc.record_id": "1"}' | span\-update\-labels \-f <(echo '1,X,Y')\fR
.PP
Create a snapshot of crossref works API message items:
.IP
\fB\fCspan\-crossref\-snapshot \-o snapshot.ldj.gz messages.ldj.gz\fR
.PP
The \fB\fCmessages.ldj.gz\fR must contain only the message portion of an crossref API
response \- one per line \- for example:
.IP
\fB\fCcurl \-sL goo.gl/Cq34Bd | jq .message\fR
.PP
Given an intermediate schema file, extract record id, source id, doi and labels
(ISIL). Can be fed into 
.BR groupcover (1) 
for deduplication.
.IP
\fB\fCspan\-local\-data < input.ldj > output.tsv\fR
.PP
Example output:
.IP
\fB\fCai\-49\-aHR0cDovL2R4LmRva...    49    10.2307/3102818    DE\-15\-FID    DE\-Ch1    DE\-105\fR
.SH Freezing a filterconfig
.PP
When given a single file containing a number of URLs, it is required to keep
both the file and all URLs it contains for a given point in time. The
\fB\fCspan\-freeze\fR tool is generic, in that it does not assume any format. It will
create a zip file with the following layout:
.PP
.RS
.nf
/blob
/mapping.json
/files/<hash>
/files/<hash>
\&...
.fi
.RE
.PP
Where \fB\fCblob\fR is the original file containing URLs, \fB\fCmapping.json\fR is a JSON document
containing a SHA1 to URL mapping and the \fB\fCfiles\fR directory contains all
responses, with the filename being the SHA1 of the URL.
.PP
Example usage:
.IP
\fB\fCspan\-freeze \-o frozen.zip < filterconfig.json\fR
.PP
Example for thawing a configuration. The zip file will be decompressed into a
temporary location and the configuration is modified accordingly before tagging
starts.
.IP
\fB\fCspan\-tag \-unfreeze frozen.zip < intermediate.file\fR
.SH INDEX REVIEWS
.PP
Since 0.1.241 it is possible to run slightly automated SOLR index reviews. The
two tools are \fB\fCspan\-review\fR for reviews and \fB\fCspan\-webhookd\fR for automatically
running a review on commits in GitLab. These tools are experimental and might
change in the future.
.PP
Start the webhook receiver:
.IP
\fB\fCspan\-webhookd\fR
.PP
Or use the service shipped with the distribution packages.
.IP
\fB\fCservicectl span\-webhookd start\fR
.PP
The service requires \fB\fC/var/log/span\-webhhokd.log\fR to be writeable by \fB\fCdaemon\fR\&.
.PP
The default port is 8080 (change this in SPAN CONFIG). The server listens on
all interfaces. The default URL is: \fB\fChttp://0.0.0.0:8080/trigger\fR\&. Enter this
URL in GitLab \fIsettings/integrations\fP\&.
.PP
The review file location is hardcoded at the moment, \fB\fCdocs/review.yaml\fR\&.
Example config file:
.PP
.RS
.nf
# Review configuration, refs #12756.
#
# Proposed workflow:
#
# 1. Edit this file via GitLab at
# https://git.sc.uni\-leipzig.de/miku/span/blob/master/docs/review.yaml. Add,
# edit or remove rules, update ticket number. If done, commit.
# 2. A trigger will run an index review based on these rules.
# 3. Find the results in your ticket, in case the ticket number was valid.

# The solr server to query, including scheme, port and collection, e.g.
# "http://localhost:8983/solr/biblio". If "auto", then the current testing solr
# server will be figured out automatically.
solr: "auto"

# The ticket number of update. Set this to "NA" or anything non\-numeric to
# suppress ticket updates.
ticket: "NA"

# Allowed keys: [Query, Facet\-Field, Value, ...] checks if all values of field
# contain only given values.
allowed\-keys:
    \- ["source_id:30", "format", "eBook", "ElectronicArticle"]
    \- ["source_id:30", "format_de15", "Book, eBook", "Article, E\-Article"]
    \- ["source_id:48", "language", "German", "English"]
    \- ["source_id:49", "facet_avail", "Online", "Free"]
    \- ["source_id:55", "facet_avail", "Online", "Free"]

# All records: [Query, Facet\-Field, Value, ...] checks if all record contain
# only the given values.
all\-records:
    \- ["source_id:28", "format", "ElectronicArticle"]
    \- ["source_id:28", "format_de15", "Article, E\-Article"]
    \- ["source_id:28", "facet_avail", "Online", "Free"]
    \- ["source_id:28", "access_facet", "Electronic Resources"]
    \- ["source_id:28", "mega_collection", "DOAJ Directory of Open Access Journals"]
    \- ["source_id:28", "finc_class_facet", "not assigned"]
    \- ["source_id:30", "facet_avail", "Online", "Free"]
    \- ["source_id:30", "access_facet", "Electronic Resources"]
    \- ["source_id:30", "mega_collection", "SSOAR Social Science Open Access Repository"]

# MinRatio: Query, Facet\-Field, Value, Ratio (Percent), checks if the given
# value appears in a given percentage of documents.
min\-ratio:
    \- ["source_id:49", "facet_avail", "Free", 0.8]
    \- ["source_id:55", "facet_avail", "Free", 2.2]
    \- ["source_id:105", "facet_avail", "Free", 0.5]

# MinCount: Query, Facet\-Field, Value, Min Count. Checks, if the given value
# appears at least a fixed number of times.
min\-count:
    \- ["source_id:89", "facet_avail", "Free", 50]
.fi
.RE
.SH SPAN CONFIG
.PP
The span config file is used by \fB\fCspan\-review\fR and \fB\fCspan\-webhookd\fR, since they
access various external systems: SOLR, Redmine, GitLab, Nginx. Default location
is \fB\fC~/.config/span/span.json\fR\&.
.PP
.RS
.nf
{
  "gitlab.token": "adszuDZZ778sdsiuDsd\-R4",
  "whatislive.url": "http://example.com/whatislive",
  "redmine.baseurl": "https://projects.example.com",
  "redmine.apitoken": "d41d8cd98f00b204e9800998ecf8427e",
  "port": 8080
}
.fi
.RE
.SH FILES
.PP
Assets (mostly string to string mappings) are compiled into the executable. To
change these mappings, edit the suitable file under
\[la]https://github.com/miku/span/tree/master/assets\[ra], commit and recompile.
.SH DIAGNOSTICS
.PP
Any error (like faulty JSON, IO errors, ...) will lead to an immediate halt.
.PP
To debug a holdings filter, set \fB\fCverbose\fR to \fB\fCtrue\fR to see rejected records and rejection reason:
.PP
.RS
.nf
{
  "DE\-14": {
    "holdings": {
      "verbose": true,
      "urls": [
        "http://www.jstor.org/kbart/collections/asii",
        "http://www.jstor.org/kbart/collections/as"
      ]
    }
  }
}
.fi
.RE
.PP
Example debugging output, record rejected because it's outside licence coverage:
.PP
.RS
.nf
2016/07/14 14:29:45 {
    "document": {
        ...
        "finc.record_id": "ai\-55\-aHR0cDovL3d3dy5qc3Rvci5vcmcvc3RhYmxlLzEwLjE0MzIxL3JoZXRwdWJsYWZmYS4xOC4xLjAxNjE",
        ...
        "rft.atitle": "Review: Depression: A Public Feeling",
        ...
        "rft.issn": [
            "1094\-8392",
            "1534\-5238"
        ],
        "rft.date": "2015\-04\-01",
        "doi": "10.14321/rhetpublaffa.18.1.0161",
        ...
    },
    "err": "after coverage interval",
    "issn": "1534\-5238",
    "license": {
        "Begin": {
            "Date": "1998\-04\-01",
            "Volume": "1",
            "Issue": "1"
        },
        "End": {
            "Date": "2012\-12\-01",
            "Volume": "15",
            "Issue": "4"
        },
        "Embargo": \-126144000000000000,
        "EmbargoDisallowEarlier": false
    }
}
.fi
.RE
.SH BUGS
.PP
Please report bugs to \[la]https://github.com/miku/span/issues\[ra]\&.
.SH AUTHOR
.PP
Martin Czygan \[la]martin.czygan@uni-leipzig.de\[ra]
.SH SEE ALSO
.PP
FINC \[la]https://finc.info\[ra], AMSL \[la]http://amsl.technology/\[ra], intermediate schema \[la]https://github.com/ubleipzig/intermediateschema\[ra], metafacture \[la]https://github.com/culturegraph\[ra], 
.BR jq (1), 
.BR xmlstarlet (1)
